{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="bg-gray-900 mt-4 flex items-center justify-center">
    <div
        class="w-full max-w-5xl bg-gray-800 shadow-md rounded-lg overflow-hidden grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
        <div class="col-span-1 bg-gray-700 rounded-lg p-4">
            <h2 class="text-2xl font-bold text-gray-100 mb-4">Community Members</h2>
            <ul class="divide-y divide-gray-600">
                {% for member in members %}
                <li
                    class="py-3 px-2 text-gray-300 hover:bg-gray-600 hover:text-white transition-colors rounded-md flex justify-between items-center">
                    <div>
                        {{ member.member.username }}
                        {% if member.member.email == user.email %}
                        (You)
                        {% endif %}
                    </div>
                    <div>
                        {% if member.is_owner %}
                        <span class="bg-red-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded">Owner</span>
                        {% elif member.is_admin %}
                        <span class="bg-blue-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded">Admin</span>
                        {% else %}
                        <span class="bg-gray-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded">Member</span>
                        {% endif %}
                        {% if can_remove and not member.is_admin %}
                        <form method="post" action="{% url 'communities:remove_member' community_id member.member.id %}"
                            enctype="multipart/form-data" class="inline-block">
                            {% csrf_token %}
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <button type="submit"
                                class="bg-red-600 text-white text-sm py-1 px-4 rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 ease-in-out">Remove</button>
                        </form>
                        {% endif %}
                        {% if user_role == 'owner' %}
                        <form method="post"
                            action="{% url 'communities:change_admin_status' community_id member.member.id %}"
                            enctype="multipart/form-data" class="inline-block">
                            {% csrf_token %}
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            {% if member.is_admin %}
                            <button type="submit"
                                class="bg-yellow-500 text-white text-sm py-1 px-4 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50 transition duration-150 ease-in-out mx-2">Demote</button>
                            {% else %}
                            <button type="submit"
                                class="bg-green-500 text-white text-sm py-1 px-4 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out mx-2">Promote</button>
                            {% endif %}
                        </form>
                        {% endif %}
                    </div>
                </li>
                {% empty %}
                <li class="py-3 text-gray-300">No members in this community yet.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-span-2 grid grid-rows-2 gap-6">
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">
                        {% if is_admin %}
                        Community Reports
                        {% else %}
                        Your Reports
                        {% endif %}
                    </h2>
                    <a href="{% url 'communities:create_report' community.id %}"
                        class="inline-flex items-center justify-center bg-orange-500 text-white p-2 rounded hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Create Report
                    </a>
                </div>
                <ul class="divide-y divide-gray-600">
                    {% for report in reports %}
                    <li
                        class="py-3 px-2 mt-1 text-gray-300 hover:bg-gray-600 hover:text-white transition-colors rounded-md">
                        <a href="{% url 'communities:view_report' community.id report.id %}"
                            class="text-gray-300 hover:text-white transition-colors">{{ report.title }}</a>
                        <span class="float-right text-gray-300">{{ report.get_status_display }}</span>
                    </li>
                    {% empty %}
                    <li class="py-3 text-gray-300">No reports submitted to this community.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <!-- Enhanced Community Information with Dropdown or More Interactivity -->
                <div class="bg-gray-700 rounded-lg p-4 relative" x-data="{ isOpen: false }">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-100 mb-4">Community Information</h2>
                        <!-- Dropdown Trigger Button -->
                        <div class="dropdown inline-block relative">
                            <button
                                class="bg-orange-500 text-white p-2 rounded hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50 transition duration-150 ease-in-out"
                                @click="isOpen = !isOpen">
                                More Actions
                                <svg class="w-4 h-4 ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <!-- Dropdown Menu -->
                            <div class="absolute right-0 mt-2 py-2 w-48 bg-gray-200 rounded-md shadow-xl z-20"
                                x-show="isOpen" x-transition>
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-300" href="#"
                                    onclick="openAnonPopup()">Create Anonymous Submission Link</a>
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-300" href="#"
                                    onclick="openInvitePopup()">Invite Members</a>
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-300" href="#">Edit
                                    Community</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-600 rounded-lg p-4">
                    <h5 class="text-lg font-semibold text-gray-100 mb-2">
                        <strong>Name:</strong> {{ community.name }}
                    </h5>
                    <p class="text-gray-300 mb-4">
                        <strong>Description:</strong> {{ community.description }}
                    </p>
                    <div class="text-gray-400 mb-4">
                        <p>Created at: {{ community.created_at }}</p>
                        <p>Updated at: {{ community.updated_at }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Invite Members Popup -->
<div id="invitePopup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white rounded-lg w-1/2 p-6">
        <h2 class="text-xl font-semibold mb-4">Create Invite Link</h2>
        <form id="inviteForm" method="post">
            {% csrf_token %}
            <div class="mb-4 justify-center items-center">
                <label for="num_invites" class="block text-sm font-medium text-gray-700">Max Number of Uses (Enter 0 for
                    No Limit)</label>
                <input type="number" name="num_invites" id="num_invites" class="mb-4 bg-gray-300" value="0">
                <label for="expiration" class="block text-sm font-medium text-gray-700">Expiration:</label>
                <select name="expiration" id="expiration"
                    class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    <option value="1h">1 Hour</option>
                    <option value="1d">1 Day</option>
                    <option value="1w">1 Week</option>
                    <option value="1m">1 Month</option>
                    <option value="never">Never</option>
                </select>
            </div>
            <div class="flex justify-end mt-2">
                <button onclick="closeInvitePopup()" type="submit"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Generate
                    Link</button>
                <button onclick="closeInvitePopup()"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openInvitePopup() {
        document.getElementById( 'invitePopup' ).classList.remove( 'hidden' );
    }

    function closeInvitePopup() {
        document.getElementById( 'invitePopup' ).classList.add( 'hidden' );
    }

    // Function to copy invite link to clipboard
    function copyToClipboard( text ) {
        const input = document.createElement( 'input' );
        input.style.position = 'fixed';
        input.style.opacity = 0;
        input.value = text;
        document.body.appendChild( input );
        input.select();
        document.execCommand( 'copy' );
        document.body.removeChild( input );
    }

    // Add event listener to form submission for copying invite link to clipboard
    document.getElementById( 'inviteForm' ).addEventListener( 'submit', function ( e ) {
        e.preventDefault();
        const numInvites = document.getElementById( 'num_invites' ).value;
        const expiration = document.getElementById( 'expiration' ).value;
        console.log( "Fetching invite link with properties: ", numInvites, expiration );
        fetch( "{% url 'communities:generate_invite' community.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify( {
                num_invites: numInvites,
                expiration: expiration,
                link_type: 'join'
            } )
        } )
            .then( response => response.json() )
            .then( data => {
                // append invite link to domain
                data.invite_link = window.location.origin + data.invite_link;
                copyToClipboard( data.invite_link );
                alert( 'Invite link copied to clipboard!' );
            } )
            .catch( error => {
                console.error( 'Error:', error );
            } );
    } );
</script>

{% endblock %}